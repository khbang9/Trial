<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>í™”ë©´ ë³€í™” ê°ì§€ ìë™ í´ë¦­</title>
    <style>
      body { margin: 0; font-family: Inter, "Pretendard", sans-serif; background: transparent; }
      .floating {
        position: fixed; top: 20px; left: 20px; width: 460px; max-height: calc(100vh - 40px);
        overflow: auto; background: rgba(15, 23, 42, 0.94); color: #e2e8f0; border-radius: 16px;
        border: 1px solid rgba(148, 163, 184, 0.25); padding: 16px; box-shadow: 0 20px 40px rgba(0,0,0,0.35);
      }
      h1 { margin: 0 0 8px; font-size: 1.2rem; }
      .small { font-size: 0.82rem; color: #94a3b8; margin-bottom: 10px; }
      .section { margin-top: 12px; }
      .section-title { color: #bae6fd; font-weight: 700; margin: 0 0 6px; }
      .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
      label { display: flex; align-items: center; gap: 4px; font-size: 0.8rem; color: #94a3b8; margin: 4px 0; }
      input, select { width: 100%; border-radius: 10px; border: 1px solid #334155; background:#020617; color:#e2e8f0; padding: 9px; }
      button { border: 0; border-radius: 10px; padding: 10px 12px; font-weight: 700; cursor: pointer; }
      .buttons { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
      .primary { background: linear-gradient(135deg, #22d3ee, #38bdf8); color: #06202b; }
      .secondary { background: #334155; color: #dbeafe; }
      .danger { background: #ef4444; color: white; }
      .status { margin-top: 8px; font-size: 0.9rem; background: #0b1224; padding: 8px 10px; border-radius: 10px; }
      ul { margin: 8px 0; padding-left: 18px; }
      .tip {
        position: relative; display: inline-flex; align-items: center; justify-content: center;
        width: 16px; height: 16px; border-radius: 999px; background: #334155; color: #bae6fd;
        font-size: 11px; cursor: help;
      }
      .tip:hover::after {
        content: attr(data-tip);
        position: absolute;
        top: calc(100% + 8px);
        left: -20px;
        width: 240px;
        background: #020617;
        color: #e2e8f0;
        border: 1px solid #334155;
        border-radius: 8px;
        padding: 8px;
        font-size: 12px;
        line-height: 1.45;
        white-space: normal;
        z-index: 20;
      }
      .kbd-row { display: grid; grid-template-columns: 1fr auto; gap: 8px; }
      .hint { font-size: 0.75rem; color: #94a3b8; margin-top: 6px; }
    </style>
  </head>
  <body>
    <div class="floating">
      <h1>ğŸ¯ í™”ë©´ ë³€í™” ê°ì§€ ìë™ í´ë¦­ê¸°</h1>
      <div class="small">ì„¤ì • ë©”ë‰´ë§Œ ì—¬ê¸°ì„œ í•˜ê³ , ì˜ì—­/í´ë¦­ ìœ„ì¹˜ëŠ” ì‹¤ì œ í™”ë©´ì—ì„œ ì˜¤ë²„ë ˆì´ë¡œ ì§ì ‘ ì„ íƒí•˜ì„¸ìš”.</div>

      <div class="section">
        <div class="section-title">ê°ì§€ ì˜ì—­</div>
        <div class="buttons">
          <button id="selectRegion" class="primary">ì˜ì—­ ì„¤ì •í•˜ê¸° (í”Œë¡œíŒ…)</button>
        </div>
        <div id="regionInfo" class="status">ê°ì§€ì˜ì—­: ë¯¸ì„ íƒ</div>
      </div>

      <div class="section">
        <div class="section-title">ëª¨ë‹ˆí„°ë§ ì„¤ì •</div>
        <div class="row">
          <div>
            <label>
              Threshold
              <span class="tip" data-tip="í”„ë ˆì„ ë³€í™” ë¯¼ê°ë„ì…ë‹ˆë‹¤. ì‘ì„ìˆ˜ë¡ ì‘ì€ ë³€í™”ì—ë„ ë°˜ì‘í•©ë‹ˆë‹¤. ë³´í†µ 6~12(ë¯¼ê°), 12~25(ê¸°ë³¸), 25 ì´ìƒ(í° ë³€í™”ë§Œ) ê¶Œì¥.">i</span>
            </label>
            <input id="threshold" type="number" value="12" min="0.1" step="0.1" />
          </div>
          <div>
            <label>í´ë§(ms)</label>
            <input id="poll" type="number" value="250" min="50" step="50" />
          </div>
        </div>
        <div>
          <label>
            ì¿¨ë‹¤ìš´(ms)
            <span class="tip" data-tip="í•œ ë²ˆ ë°˜ì‘í•œ ë’¤ ë‹¤ìŒ ë°˜ì‘ê¹Œì§€ ê¸°ë‹¤ë¦¬ëŠ” ì‹œê°„ì…ë‹ˆë‹¤. 0~300ì€ ì—°íƒ€ ì„±í–¥, 500~1500ì€ ì¼ë°˜ ì¶”ì²œ, 2000 ì´ìƒì€ ì˜¤ì‘ë™ ë°©ì§€ì— ìœ ë¦¬í•©ë‹ˆë‹¤.">i</span>
          </label>
          <input id="cooldown" type="number" value="1000" min="0" step="100" />
        </div>
      </div>

      <div class="section">
        <div class="section-title">ë‹¨ì¶•í‚¤ ì„¤ì •</div>
        <div class="row">
          <div>
            <label>ì‹œì‘ ë‹¨ì¶•í‚¤</label>
            <div class="kbd-row">
              <input id="startHotkey" type="text" readonly value="Ctrl+Alt+S" />
              <button id="captureStartHotkey" class="secondary">ì…ë ¥</button>
            </div>
          </div>
          <div>
            <label>ì¤‘ì§€ ë‹¨ì¶•í‚¤</label>
            <div class="kbd-row">
              <input id="stopHotkey" type="text" readonly value="Ctrl+Alt+X" />
              <button id="captureStopHotkey" class="secondary">ì…ë ¥</button>
            </div>
          </div>
        </div>
        <div class="hint">â€» ë‹¨ì¶•í‚¤ëŠ” ì´ í˜ì´ì§€ê°€ ì—´ë¦° ìƒíƒœì—ì„œ ë™ì‘í•©ë‹ˆë‹¤. (ì˜ˆ: Ctrl+Alt+S ì‹œì‘, Ctrl+Alt+X ì¤‘ì§€)</div>
      </div>

      <div class="section">
        <div class="section-title">í´ë¦­ ì•¡ì…˜ ì¶”ê°€</div>
        <div class="buttons">
          <button class="secondary" id="pickActionPoint">í´ë¦­ ìœ„ì¹˜ í™”ë©´ì—ì„œ ì„ íƒ</button>
        </div>
        <div class="row">
          <div><label>X</label><input id="actX" type="number" min="0" value="300" /></div>
          <div><label>Y</label><input id="actY" type="number" min="0" value="300" /></div>
        </div>
        <div class="row">
          <div><label>í´ë¦­ íšŸìˆ˜</label><input id="actClicks" type="number" min="1" max="20" value="1" /></div>
          <div><label>ì¸í„°ë²Œ(ms)</label><input id="actInterval" type="number" min="0" value="100" /></div>
        </div>
        <div class="row">
          <div><label>ë²„íŠ¼</label><select id="actButton"><option value="left">left</option><option value="right">right</option><option value="middle">middle</option></select></div>
          <div><label>ë¼ë²¨</label><input id="actLabel" type="text" value="Action" /></div>
        </div>
        <div class="buttons">
          <button class="secondary" id="addAction">ì•¡ì…˜ ì¶”ê°€</button>
          <button class="secondary" id="clearActions">ëª©ë¡ ë¹„ìš°ê¸°</button>
        </div>
        <ul id="actionList"></ul>
      </div>

      <div class="buttons">
        <button class="primary" id="startBtn">ëª¨ë‹ˆí„°ë§ ì‹œì‘</button>
        <button class="danger" id="stopBtn">ì¤‘ì§€</button>
      </div>
      <div class="status" id="statusBox">ìƒíƒœ: ëŒ€ê¸°ì¤‘</div>
    </div>

    <script>
      const statusBox = document.getElementById('statusBox');
      const regionInfo = document.getElementById('regionInfo');
      const actionListEl = document.getElementById('actionList');
      const startHotkeyInput = document.getElementById('startHotkey');
      const stopHotkeyInput = document.getElementById('stopHotkey');
      let monitorRegion = null;
      let actions = [];
      let hotkeys = {
        start: localStorage.getItem('startHotkey') || 'Ctrl+Alt+S',
        stop: localStorage.getItem('stopHotkey') || 'Ctrl+Alt+X',
      };
      let captureTarget = null;

      function setStatus(text) { statusBox.textContent = text; }
      function setRegionText() {
        if (!monitorRegion) {
          regionInfo.textContent = 'ê°ì§€ì˜ì—­: ë¯¸ì„ íƒ';
          return;
        }
        regionInfo.textContent = `ê°ì§€ì˜ì—­: (${monitorRegion.x}, ${monitorRegion.y}) ${monitorRegion.width}Ã—${monitorRegion.height}`;
      }
      function renderActions() {
        actionListEl.innerHTML = actions.map((a, i) => `<li>${i + 1}. ${a.label} â†’ (${a.x},${a.y}), ${a.clicks}íšŒ, ${a.interval_ms}ms, ${a.button}</li>`).join('');
      }
      function renderHotkeys() {
        startHotkeyInput.value = hotkeys.start;
        stopHotkeyInput.value = hotkeys.stop;
      }
      function normalizeCombo(e) {
        const parts = [];
        if (e.ctrlKey) parts.push('Ctrl');
        if (e.altKey) parts.push('Alt');
        if (e.shiftKey) parts.push('Shift');
        if (e.metaKey) parts.push('Meta');
        const key = e.key.length === 1 ? e.key.toUpperCase() : e.key;
        if (!['Control', 'Alt', 'Shift', 'Meta'].includes(key)) parts.push(key);
        return parts.join('+');
      }

      async function startMonitoring() {
        if (!monitorRegion) return setStatus('ë¨¼ì € [ì˜ì—­ ì„¤ì •í•˜ê¸°]ë¥¼ ëˆŒëŸ¬ ê°ì§€ì˜ì—­ì„ ì„ íƒí•˜ì„¸ìš”.');
        if (!actions.length) return setStatus('ìµœì†Œ 1ê°œ ì•¡ì…˜ì„ ì¶”ê°€í•˜ì„¸ìš”.');

        const payload = {
          region: monitorRegion,
          threshold: Number(document.getElementById('threshold').value),
          poll_interval_ms: Number(document.getElementById('poll').value),
          cooldown_ms: Number(document.getElementById('cooldown').value),
          actions,
        };

        const res = await fetch('/api/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        setStatus(data.message || 'ì‹œì‘ë¨');
      }

      async function stopMonitoring() {
        const res = await fetch('/api/stop', { method: 'POST' });
        const data = await res.json();
        setStatus(data.message || 'ì¤‘ì§€ë¨');
      }

      document.getElementById('selectRegion').addEventListener('click', async () => {
        setStatus('ì˜ì—­ ì˜¤ë²„ë ˆì´ë¥¼ ë„ìš°ëŠ” ì¤‘...');
        const res = await fetch('/api/select-region', { method: 'POST' });
        const data = await res.json();
        if (!res.ok || !data.ok) {
          setStatus(`ì˜ì—­ ì„ íƒ ì‹¤íŒ¨: ${data.detail || 'unknown error'}`);
          return;
        }
        monitorRegion = data.region;
        setRegionText();
        setStatus('ê°ì§€ì˜ì—­ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
      });

      document.getElementById('pickActionPoint').addEventListener('click', async () => {
        setStatus('í´ë¦­ ìœ„ì¹˜ ì˜¤ë²„ë ˆì´ë¥¼ ë„ìš°ëŠ” ì¤‘...');
        const res = await fetch('/api/select-point', { method: 'POST' });
        const data = await res.json();
        if (!res.ok || !data.ok) {
          setStatus(`í´ë¦­ ìœ„ì¹˜ ì„ íƒ ì‹¤íŒ¨: ${data.detail || 'unknown error'}`);
          return;
        }
        document.getElementById('actX').value = data.point.x;
        document.getElementById('actY').value = data.point.y;
        setStatus(`í´ë¦­ ìœ„ì¹˜ ì„ íƒ ì™„ë£Œ: (${data.point.x}, ${data.point.y})`);
      });

      document.getElementById('addAction').addEventListener('click', () => {
        actions.push({
          x: Number(document.getElementById('actX').value),
          y: Number(document.getElementById('actY').value),
          clicks: Number(document.getElementById('actClicks').value),
          interval_ms: Number(document.getElementById('actInterval').value),
          button: document.getElementById('actButton').value,
          label: document.getElementById('actLabel').value || 'Action',
        });
        renderActions();
      });

      document.getElementById('clearActions').addEventListener('click', () => {
        actions = [];
        renderActions();
      });

      document.getElementById('startBtn').addEventListener('click', startMonitoring);
      document.getElementById('stopBtn').addEventListener('click', stopMonitoring);

      document.getElementById('captureStartHotkey').addEventListener('click', () => {
        captureTarget = 'start';
        setStatus('ì‹œì‘ ë‹¨ì¶•í‚¤ ì…ë ¥ ëŒ€ê¸°ì¤‘... ì›í•˜ëŠ” í‚¤ ì¡°í•©ì„ ëˆ„ë¥´ì„¸ìš”.');
      });

      document.getElementById('captureStopHotkey').addEventListener('click', () => {
        captureTarget = 'stop';
        setStatus('ì¤‘ì§€ ë‹¨ì¶•í‚¤ ì…ë ¥ ëŒ€ê¸°ì¤‘... ì›í•˜ëŠ” í‚¤ ì¡°í•©ì„ ëˆ„ë¥´ì„¸ìš”.');
      });

      document.addEventListener('keydown', async (e) => {
        const combo = normalizeCombo(e);

        if (captureTarget) {
          e.preventDefault();
          if (combo === hotkeys.start || combo === hotkeys.stop) {
            setStatus('ì¤‘ë³µ ë‹¨ì¶•í‚¤ëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
            return;
          }
          hotkeys[captureTarget] = combo;
          localStorage.setItem(`${captureTarget}Hotkey`, combo);
          renderHotkeys();
          setStatus(`${captureTarget === 'start' ? 'ì‹œì‘' : 'ì¤‘ì§€'} ë‹¨ì¶•í‚¤ ì„¤ì •: ${combo}`);
          captureTarget = null;
          return;
        }

        if (combo === hotkeys.start) {
          e.preventDefault();
          await startMonitoring();
        } else if (combo === hotkeys.stop) {
          e.preventDefault();
          await stopMonitoring();
        }
      });

      setInterval(async () => {
        const res = await fetch('/api/status');
        const s = await res.json();
        if (s.running) {
          const diff = Number(s.last_diff || 0).toFixed(2);
          setStatus(`ì‹¤í–‰ì¤‘ Â· last diff=${diff}`);
        }
      }, 1000);

      setRegionText();
      renderHotkeys();
    </script>
  </body>
</html>
