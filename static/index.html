<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ë‹¤ì¤‘ êµ¬ì—­ í™”ë©´ ë³€í™” ê°ì§€</title>
    <style>
      body { margin:0; font-family: Inter, "Pretendard", sans-serif; }
      .floating { position:fixed; top:20px; left:20px; width:500px; max-height:calc(100vh - 40px); overflow:auto; background:rgba(15,23,42,.95); color:#e2e8f0; border-radius:16px; border:1px solid #334155; padding:16px; }
      .chip { position:fixed; top:12px; right:12px; background:rgba(15,23,42,.8); color:#86efac; border:1px solid #22d3ee; border-radius:10px; padding:6px 10px; display:none; z-index:50; font-size:12px; }
      .section { margin-top:12px; }
      .row { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
      .buttons { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
      input, select { width:100%; border-radius:10px; border:1px solid #334155; background:#020617; color:#e2e8f0; padding:8px; }
      button { border:0; border-radius:10px; padding:9px 11px; font-weight:700; cursor:pointer; }
      .primary { background:linear-gradient(135deg,#22d3ee,#38bdf8); color:#06202b; }
      .secondary { background:#334155; color:#dbeafe; }
      .danger { background:#ef4444; color:white; }
      .status { margin-top:8px; background:#0b1224; border-radius:10px; padding:8px 10px; font-size:.9rem; }
      .rule { background:#0b1224; border:1px solid #334155; border-radius:10px; padding:8px; margin-top:8px; }
      .tip { cursor:help; color:#7dd3fc; font-weight:700; }
      label { font-size:12px; color:#94a3b8; display:block; margin:4px 0; }
    </style>
  </head>
  <body>
    <div id="chip" class="chip">ëª¨ë‹ˆí„°ë§ì¤‘</div>
    <div class="floating">
      <h2>ğŸ¯ ë‹¤ì¤‘ êµ¬ì—­ ëª¨ë‹ˆí„°ë§</h2>
      <div style="font-size:12px;color:#94a3b8">ì‹œë‹ˆì–´ 3ì¸ í† ë¡ ì•ˆ ê¸°ë°˜: êµ¬ì—­ë³„ ë…ë¦½ ì„ê³„ê°’/ì¿¨ë‹¤ìš´ + ì•¡ì…˜ ë§¤í•‘ êµ¬ì¡°</div>

      <div class="section">
        <h3>ì „ì—­ ì„¤ì •</h3>
        <div class="row">
          <div><label>í´ë§(ms)</label><input id="poll" type="number" min="50" step="50" value="250"></div>
          <div><label>ì‹œì‘ ë‹¨ì¶•í‚¤</label><input id="startHotkey" readonly value="Ctrl+Alt+S"></div>
        </div>
        <div class="row">
          <div><label>ì¤‘ì§€ ë‹¨ì¶•í‚¤</label><input id="stopHotkey" readonly value="Ctrl+Alt+X"></div>
          <div class="buttons" style="align-items:end"><button id="setHotkeys" class="secondary">ë‹¨ì¶•í‚¤ ì €ì¥</button></div>
        </div>
      </div>

      <div class="section">
        <h3>ëª¨ë‹ˆí„°ë§ êµ¬ì—­ ê·œì¹™ ì¶”ê°€</h3>
        <div class="row">
          <div><label>ê·œì¹™ ì´ë¦„</label><input id="ruleName" value="êµ¬ì—­ 1"></div>
          <div><label>í´ë¦­ ë¼ë²¨</label><input id="actionLabel" value="Aì§€ì "></div>
        </div>
        <div class="row">
          <div><label>Threshold <span class="tip" title="ì‘ì„ìˆ˜ë¡ ë¯¼ê°: 6~12 ë¯¼ê° / 12~25 ê¸°ë³¸ / 25+ í° ë³€í™”ë§Œ">i</span></label><input id="ruleThreshold" type="number" step="0.1" value="12"></div>
          <div><label>ì¿¨ë‹¤ìš´(ms) <span class="tip" title="ë°˜ì‘ í›„ ì¬ë°˜ì‘ ëŒ€ê¸°ì‹œê°„: 500~1500 ê¸°ë³¸">i</span></label><input id="ruleCooldown" type="number" step="100" value="1000"></div>
        </div>
        <div class="row">
          <div><label>í´ë¦­ íšŸìˆ˜</label><input id="clicks" type="number" min="1" max="20" value="1"></div>
          <div><label>ì¸í„°ë²Œ(ms)</label><input id="interval" type="number" min="0" value="80"></div>
        </div>
        <div class="row">
          <div><label>ë²„íŠ¼</label><select id="button"><option value="left">left</option><option value="right">right</option><option value="middle">middle</option></select></div>
          <div><label>í´ë¦­ ì¢Œí‘œ</label><input id="pointText" readonly value="ë¯¸ì„ íƒ"></div>
        </div>
        <div class="buttons">
          <button id="pickRegion" class="secondary">êµ¬ì—­ ì„ íƒ</button>
          <button id="pickPoint" class="secondary">í´ë¦­ì  ì„ íƒ</button>
          <button id="addRule" class="primary">ê·œì¹™ ì¶”ê°€</button>
        </div>
      </div>

      <div class="section">
        <h3>ê·œì¹™ ëª©ë¡</h3>
        <div id="rules"></div>
        <div class="buttons">
          <button id="saveConfig" class="secondary">ì„¤ì • ì €ì¥</button>
          <button id="startBtn" class="primary">ëª¨ë‹ˆí„°ë§ ì‹œì‘</button>
          <button id="stopBtn" class="danger">ì¤‘ì§€</button>
        </div>
      </div>

      <div id="status" class="status">ìƒíƒœ: ëŒ€ê¸°ì¤‘</div>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);
      const state = { rules: [], pickedRegion: null, pickedPoint: null, capture: null, lastMessage: '' };

      function setStatus(t) { $('status').textContent = `ìƒíƒœ: ${t}`; }
      function uid() { return `rule-${Date.now()}-${Math.floor(Math.random()*1000)}`; }
      function ruleCard(r, idx) {
        return `<div class="rule"><b>${idx+1}. ${r.name}</b><br>ì˜ì—­ (${r.region.x},${r.region.y}) ${r.region.width}Ã—${r.region.height}<br>íŠ¸ë¦¬ê±°â†’ ${r.actions[0].label} (${r.actions[0].x},${r.actions[0].y})</div>`;
      }
      function renderRules() { $('rules').innerHTML = state.rules.map(ruleCard).join('') || '<div style="color:#94a3b8;font-size:12px">ì•„ì§ ê·œì¹™ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; }
      function buildConfig() { return { poll_interval_ms: Number($('poll').value), rules: state.rules }; }

      async function saveConfig(show=true) {
        if (!state.rules.length) return show && setStatus('ê·œì¹™ì„ 1ê°œ ì´ìƒ ì¶”ê°€í•˜ì„¸ìš”.');
        const res = await fetch('/api/config', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(buildConfig()) });
        const data = await res.json();
        setStatus(data.message || 'ì„¤ì • ì €ì¥ ì™„ë£Œ');
      }

      $('pickRegion').addEventListener('click', async () => {
        setStatus('êµ¬ì—­ ì˜¤ë²„ë ˆì´ ì‹¤í–‰ì¤‘...');
        const r = await fetch('/api/select-region', { method: 'POST' });
        const d = await r.json();
        if (!r.ok || !d.ok) return setStatus(`êµ¬ì—­ ì„ íƒ ì‹¤íŒ¨: ${d.detail || 'error'}`);
        state.pickedRegion = d.region;
        setStatus(`êµ¬ì—­ ì„ íƒë¨ (${d.region.x},${d.region.y}) ${d.region.width}Ã—${d.region.height}`);
      });

      $('pickPoint').addEventListener('click', async () => {
        setStatus('í´ë¦­ì  ì˜¤ë²„ë ˆì´ ì‹¤í–‰ì¤‘...');
        const r = await fetch('/api/select-point', { method: 'POST' });
        const d = await r.json();
        if (!r.ok || !d.ok) return setStatus(`í´ë¦­ì  ì„ íƒ ì‹¤íŒ¨: ${d.detail || 'error'}`);
        state.pickedPoint = d.point;
        $('pointText').value = `(${d.point.x}, ${d.point.y})`;
        setStatus('í´ë¦­ì  ì„ íƒ ì™„ë£Œ');
      });

      $('addRule').addEventListener('click', () => {
        if (!state.pickedRegion) return setStatus('êµ¬ì—­ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.');
        if (!state.pickedPoint) return setStatus('í´ë¦­ì ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.');
        const rule = {
          id: uid(),
          name: $('ruleName').value || `êµ¬ì—­ ${state.rules.length+1}`,
          region: state.pickedRegion,
          threshold: Number($('ruleThreshold').value),
          cooldown_ms: Number($('ruleCooldown').value),
          actions: [{
            x: state.pickedPoint.x,
            y: state.pickedPoint.y,
            clicks: Number($('clicks').value),
            interval_ms: Number($('interval').value),
            button: $('button').value,
            label: $('actionLabel').value || 'Action'
          }]
        };
        state.rules.push(rule);
        renderRules();
        setStatus(`ê·œì¹™ ì¶”ê°€ë¨: ${rule.name}`);
      });

      async function saveHotkeys() {
        const payload = { start_hotkey: $('startHotkey').value, stop_hotkey: $('stopHotkey').value };
        const res = await fetch('/api/hotkeys', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const data = await res.json();
        if (!res.ok || !data.ok) return setStatus(`ë‹¨ì¶•í‚¤ ì €ì¥ ì‹¤íŒ¨: ${data.detail || 'error'}`);
        setStatus('ë‹¨ì¶•í‚¤ ì €ì¥ ì™„ë£Œ');
      }

      $('setHotkeys').addEventListener('click', saveHotkeys);
      $('saveConfig').addEventListener('click', () => saveConfig(true));
      $('startBtn').addEventListener('click', async () => { await saveConfig(false); const r=await fetch('/api/start',{method:'POST'}); const d=await r.json(); setStatus(d.message||'ì‹œì‘'); });
      $('stopBtn').addEventListener('click', async () => { const r=await fetch('/api/stop',{method:'POST'}); const d=await r.json(); setStatus(d.message||'ì¤‘ì§€'); });

      document.addEventListener('keydown', (e) => {
        const parts=[]; if(e.ctrlKey)parts.push('Ctrl'); if(e.altKey)parts.push('Alt'); if(e.shiftKey)parts.push('Shift'); if(e.metaKey)parts.push('Meta');
        const key=e.key.length===1?e.key.toUpperCase():e.key;
        if(!['Control','Alt','Shift','Meta'].includes(key)) parts.push(key);
        if (state.capture) {
          e.preventDefault();
          $(state.capture).value = parts.join('+');
          state.capture = null;
          setStatus('ë‹¨ì¶•í‚¤ ì…ë ¥ë¨. [ë‹¨ì¶•í‚¤ ì €ì¥]ì„ ëˆ„ë¥´ì„¸ìš”.');
        }
      });

      $('startHotkey').addEventListener('click', ()=>{state.capture='startHotkey'; setStatus('ì‹œì‘ ë‹¨ì¶•í‚¤ ì…ë ¥ ëŒ€ê¸°ì¤‘...');});
      $('stopHotkey').addEventListener('click', ()=>{state.capture='stopHotkey'; setStatus('ì¤‘ì§€ ë‹¨ì¶•í‚¤ ì…ë ¥ ëŒ€ê¸°ì¤‘...');});

      setInterval(async () => {
        const res = await fetch('/api/status');
        const s = await res.json();
        if (s.hotkeys) { $('startHotkey').value = s.hotkeys.start_hotkey; $('stopHotkey').value = s.hotkeys.stop_hotkey; }
        $('chip').style.display = s.running ? 'block' : 'none';
        $('chip').textContent = s.running ? `ëª¨ë‹ˆí„°ë§ì¤‘ Â· ì¤‘ì§€ ${$('stopHotkey').value}` : '';
        if (s.last_message && s.last_message !== state.lastMessage) { state.lastMessage = s.last_message; setStatus(s.last_message); }
      }, 900);

      renderRules();
    </script>
  </body>
</html>
