<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ë‹¤ì¤‘ êµ¬ì—­ ëª¨ë‹ˆí„°ë§</title>
    <style>
      body { margin: 0; font-family: Inter, "Pretendard", sans-serif; background:#0b1220; color:#e2e8f0; }
      .floating { position: fixed; top: 12px; left: 12px; width: min(640px, calc(100vw - 24px)); max-height: calc(100vh - 24px); overflow: auto; background: rgba(15,23,42,.95); border:1px solid #334155; border-radius:14px; padding:12px; }
      .chip { position: fixed; top: 12px; right: 12px; border:1px solid #22d3ee; border-radius:10px; padding:6px 10px; background: rgba(15,23,42,.88); color:#86efac; display:none; z-index:99; font-size:12px; }
      h2 { margin:0; font-size:1.7rem; }
      .desc { color:#94a3b8; font-size:12px; margin:4px 0 8px; }
      .status-banner { margin-top:8px; border-radius:10px; padding:8px 10px; font-size:13px; background:#1e293b; border:1px solid #334155; }
      .status-banner.running { background:#0f3f38; border-color:#34d399; color:#d1fae5; }
      .status-banner.done { background:#3f2f0f; border-color:#f59e0b; color:#fef3c7; }
      details { background:#0b1224; border:1px solid #334155; border-radius:10px; margin-top:8px; }
      summary { cursor:pointer; padding:8px 10px; font-weight:700; }
      .box { padding: 0 10px 10px; }
      .row { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
      label { font-size:12px; color:#94a3b8; display:block; margin:4px 0; }
      input, select { width:100%; border-radius:9px; border:1px solid #334155; background:#020617; color:#e2e8f0; padding:7px; }
      .buttons { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
      button { border:0; border-radius:9px; padding:8px 11px; font-weight:700; cursor:pointer; }
      .primary { background:linear-gradient(135deg,#22d3ee,#38bdf8); color:#06202b; }
      .secondary { background:#334155; color:#dbeafe; }
      .danger { background:#ef4444; color:#fff; }
      .rules { max-height:140px; overflow:auto; }
      .rule { border:1px solid #334155; border-radius:9px; padding:7px; margin-top:6px; font-size:12px; }
    </style>
  </head>
  <body>
    <div id="chip" class="chip">ëª¨ë‹ˆí„°ë§ì¤‘</div>
    <div class="floating">
      <h2>ğŸ¯ ë‹¤ì¤‘ êµ¬ì—­ ëª¨ë‹ˆí„°ë§</h2>
      <div class="desc">êµ¬ì—­ë³„ ê·œì¹™ ì¶”ê°€: 1ë²ˆ êµ¬ì—­â†’A í´ë¦­, 2ë²ˆ êµ¬ì—­â†’B í´ë¦­ êµ¬ì¡°</div>
      <div id="banner" class="status-banner">ëŒ€ê¸°ì¤‘</div>

      <details open>
        <summary>ì „ì—­ ì„¤ì •</summary>
        <div class="box">
          <div class="row">
            <div><label>í´ë§(ms)</label><input id="poll" type="number" min="50" step="50" value="250"></div>
            <div><label>ì‹œì‘ ë‹¨ì¶•í‚¤</label><input id="startHotkey" readonly value="Ctrl+Alt+S"></div>
          </div>
          <div class="row">
            <div><label>ì¤‘ì§€ ë‹¨ì¶•í‚¤</label><input id="stopHotkey" readonly value="Ctrl+Alt+X"></div>
            <div class="buttons" style="align-items:end"><button id="setHotkeys" class="secondary">ë‹¨ì¶•í‚¤ ì €ì¥</button></div>
          </div>
          <div class="desc">ë‹¨ì¶•í‚¤ ì…ë ¥ í›„ ì €ì¥ ì „ì—ëŠ” ê°’ì´ ìœ ì§€ë©ë‹ˆë‹¤.</div>
        </div>
      </details>

      <details open>
        <summary>êµ¬ì—­ ê·œì¹™ ì¶”ê°€</summary>
        <div class="box">
          <div class="row">
            <div><label>ê·œì¹™ ì´ë¦„</label><input id="ruleName" value="êµ¬ì—­ 1"></div>
            <div><label>í´ë¦­ ë¼ë²¨</label><input id="actionLabel" value="Aì§€ì "></div>
          </div>
          <div class="row">
            <div><label>Threshold</label><input id="ruleThreshold" type="number" step="0.1" value="12"></div>
            <div><label>ì¿¨ë‹¤ìš´(ms)</label><input id="ruleCooldown" type="number" step="100" value="1000"></div>
          </div>
          <div class="row">
            <div><label>í´ë¦­ íšŸìˆ˜</label><input id="clicks" type="number" min="1" max="20" value="1"></div>
            <div><label>ì¸í„°ë²Œ(ms)</label><input id="interval" type="number" min="0" value="80"></div>
          </div>
          <div class="row">
            <div><label>ë²„íŠ¼</label><select id="button"><option value="left">left</option><option value="right">right</option><option value="middle">middle</option></select></div>
            <div><label>í´ë¦­ ì¢Œí‘œ</label><input id="pointText" readonly value="ë¯¸ì„ íƒ"></div>
          </div>
          <div class="buttons">
            <button id="pickRegion" class="secondary">êµ¬ì—­ ì„ íƒ</button>
            <button id="pickPoint" class="secondary">í´ë¦­ì  ì„ íƒ</button>
            <button id="addRule" class="primary">ê·œì¹™ ì¶”ê°€</button>
          </div>
        </div>
      </details>

      <details open>
        <summary>ê·œì¹™ ëª©ë¡ & ì‹¤í–‰</summary>
        <div class="box">
          <div id="rules" class="rules"></div>
          <div class="buttons">
            <button id="saveConfig" class="secondary">ì„¤ì • ì €ì¥</button>
            <button id="startBtn" class="primary">ëª¨ë‹ˆí„°ë§ ì‹œì‘</button>
            <button id="stopBtn" class="danger">ì¤‘ì§€</button>
          </div>
        </div>
      </details>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);
      const state = { rules: [], pickedRegion: null, pickedPoint: null, capture: null, lastMessage: '', hotkeyDirty: false };

      function setStatus(t, mode='idle') {
        const b = $('banner');
        b.textContent = t;
        b.className = `status-banner ${mode}`;
      }
      function uid() { return `rule-${Date.now()}-${Math.floor(Math.random()*1000)}`; }
      function ruleCard(r, i) { return `<div class="rule"><b>${i+1}. ${r.name}</b> Â· th:${r.threshold}, cd:${r.cooldown_ms}ms<br>ì˜ì—­ (${r.region.x},${r.region.y}) ${r.region.width}Ã—${r.region.height}<br>â†’ ${r.actions[0].label} (${r.actions[0].x},${r.actions[0].y})</div>`; }
      function renderRules(){ $('rules').innerHTML = state.rules.map(ruleCard).join('') || '<div class="desc">ê·œì¹™ ì—†ìŒ</div>'; }
      function buildConfig(){ return { poll_interval_ms: Number($('poll').value), rules: state.rules }; }

      async function saveConfig(show=true){
        if(!state.rules.length){ if(show) setStatus('ê·œì¹™ì„ 1ê°œ ì´ìƒ ì¶”ê°€í•˜ì„¸ìš”.'); return; }
        const r = await fetch('/api/config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(buildConfig())});
        const d = await r.json();
        if(show) setStatus(d.message || 'ì„¤ì • ì €ì¥ ì™„ë£Œ');
      }

      async function saveHotkeys(){
        const payload = { start_hotkey:$('startHotkey').value, stop_hotkey:$('stopHotkey').value };
        const r = await fetch('/api/hotkeys',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        const d = await r.json();
        if(!r.ok || !d.ok) return setStatus(`ë‹¨ì¶•í‚¤ ì €ì¥ ì‹¤íŒ¨: ${d.detail || 'error'}`);
        state.hotkeyDirty = false;
        setStatus('ë‹¨ì¶•í‚¤ ì €ì¥ ì™„ë£Œ');
      }

      $('pickRegion').addEventListener('click', async ()=>{
        setStatus('êµ¬ì—­ ì„ íƒ ì˜¤ë²„ë ˆì´ ì‹¤í–‰ì¤‘...');
        const r=await fetch('/api/select-region',{method:'POST'}); const d=await r.json();
        if(!r.ok || !d.ok) return setStatus(`êµ¬ì—­ ì„ íƒ ì‹¤íŒ¨: ${d.detail || 'error'}`);
        state.pickedRegion=d.region; setStatus(`êµ¬ì—­ ì„ íƒ ì™„ë£Œ (${d.region.width}x${d.region.height})`);
      });
      $('pickPoint').addEventListener('click', async ()=>{
        setStatus('í´ë¦­ì  ì„ íƒ ì˜¤ë²„ë ˆì´ ì‹¤í–‰ì¤‘...');
        const r=await fetch('/api/select-point',{method:'POST'}); const d=await r.json();
        if(!r.ok || !d.ok) return setStatus(`í´ë¦­ì  ì„ íƒ ì‹¤íŒ¨: ${d.detail || 'error'}`);
        state.pickedPoint=d.point; $('pointText').value=`(${d.point.x}, ${d.point.y})`; setStatus('í´ë¦­ì  ì„ íƒ ì™„ë£Œ');
      });

      $('addRule').addEventListener('click', ()=>{
        if(!state.pickedRegion) return setStatus('êµ¬ì—­ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.');
        if(!state.pickedPoint) return setStatus('í´ë¦­ì ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.');
        const rule={ id:uid(), name:$('ruleName').value||`êµ¬ì—­ ${state.rules.length+1}`, region:state.pickedRegion, threshold:Number($('ruleThreshold').value), cooldown_ms:Number($('ruleCooldown').value), actions:[{ x:state.pickedPoint.x,y:state.pickedPoint.y,clicks:Number($('clicks').value),interval_ms:Number($('interval').value),button:$('button').value,label:$('actionLabel').value||'Action' }]};
        state.rules.push(rule); renderRules(); setStatus(`ê·œì¹™ ì¶”ê°€ë¨: ${rule.name}`);
      });

      $('saveConfig').addEventListener('click', ()=>saveConfig(true));
      $('setHotkeys').addEventListener('click', saveHotkeys);
      $('startBtn').addEventListener('click', async ()=>{ await saveConfig(false); const r=await fetch('/api/start',{method:'POST'}); const d=await r.json(); setStatus(d.message||'ëª¨ë‹ˆí„°ë§ ì‹œì‘','running'); });
      $('stopBtn').addEventListener('click', async ()=>{ const r=await fetch('/api/stop',{method:'POST'}); const d=await r.json(); setStatus(d.message||'ëª¨ë‹ˆí„°ë§ í•´ì œ'); });

      document.addEventListener('keydown', (e)=>{
        const parts=[]; if(e.ctrlKey)parts.push('Ctrl'); if(e.altKey)parts.push('Alt'); if(e.shiftKey)parts.push('Shift'); if(e.metaKey)parts.push('Meta');
        const key=e.key.length===1?e.key.toUpperCase():e.key;
        if(!['Control','Alt','Shift','Meta'].includes(key)) parts.push(key);
        if(state.capture){ e.preventDefault(); $(state.capture).value = parts.join('+'); state.capture=null; state.hotkeyDirty=true; setStatus('ë‹¨ì¶•í‚¤ ì…ë ¥ë¨. [ë‹¨ì¶•í‚¤ ì €ì¥] í´ë¦­'); }
      });
      $('startHotkey').addEventListener('click', ()=>{state.capture='startHotkey'; setStatus('ì‹œì‘ ë‹¨ì¶•í‚¤ ì…ë ¥ ëŒ€ê¸°ì¤‘...');});
      $('stopHotkey').addEventListener('click', ()=>{state.capture='stopHotkey'; setStatus('ì¤‘ì§€ ë‹¨ì¶•í‚¤ ì…ë ¥ ëŒ€ê¸°ì¤‘...');});

      setInterval(async ()=>{
        const r = await fetch('/api/status'); const s = await r.json();
        if(s.hotkeys && !state.hotkeyDirty){ $('startHotkey').value=s.hotkeys.start_hotkey; $('stopHotkey').value=s.hotkeys.stop_hotkey; }
        $('chip').style.display = s.running ? 'block':'none';
        $('chip').textContent = s.running ? `ëª¨ë‹ˆí„°ë§ì¤‘ Â· ì¤‘ì§€ ${$('stopHotkey').value}` : '';
        if(s.last_message && s.last_message !== state.lastMessage){
          state.lastMessage = s.last_message;
          if(s.last_message.includes('ì™„ë£Œ')) setStatus(s.last_message,'done');
          else if(s.running) setStatus(s.last_message,'running');
          else setStatus(s.last_message);
        }
      }, 900);

      renderRules();
      setStatus('ëŒ€ê¸°ì¤‘');
    </script>
  </body>
</html>
